# GCP 免费层配置指南

## 🆓 GCP 免费层额度

### Cloud Run 免费额度（每月）
- ✅ **200 万次请求** - 足够中小型网站使用
- ✅ **360,000 GB-秒内存** - 约等于 1 个 256Mi 实例运行 1,440,000 秒（约 16.7 天）
- ✅ **180,000 vCPU-秒** - 约等于 1 个 0.5 CPU 实例运行 360,000 秒（约 4.2 天）
- ✅ **200 万次出站网络流量** - 足够正常使用

### Cloud Build 免费额度（每天）
- ✅ **120 构建分钟** - 每天免费构建时间
- ✅ **10 并发构建**

### Artifact Registry 免费额度
- ✅ **0.5 GB 存储** - 足够存储多个 Docker 镜像版本
- ✅ **5 GB 出站流量**

---

## ⚙️ 当前免费层优化配置

### Cloud Run 服务配置
```yaml
内存: 256Mi (最小配置)
CPU: 0.5 (最小配置)
最小实例: 0 (无流量时不运行，不产生费用)
最大实例: 5 (限制并发，控制成本)
超时: 300 秒
并发: 80 请求/实例
```

### 为什么选择这些配置？

1. **256Mi 内存 + 0.5 CPU**
   - 这是 Cloud Run 允许的最小配置
   - 对于静态网站 + 轻量 API 调用完全足够
   - 最大化免费额度的使用时间

2. **最小实例 = 0**
   - 无流量时服务停止，不产生费用
   - 首次请求会有冷启动（约 1-3 秒）
   - 适合流量不稳定的网站

3. **最大实例 = 5**
   - 限制突发流量时的实例数量
   - 防止意外高流量产生费用
   - 5 个实例可处理约 400 并发请求（5 × 80）

4. **使用 Artifact Registry**
   - Container Registry 有存储费用
   - Artifact Registry 免费层提供 0.5GB 存储
   - 更现代的镜像仓库服务

---

## 📊 免费额度使用估算

### 场景 1: 低流量网站（每月 10,000 次请求）
- 请求数：10,000 / 2,000,000 = **0.5%** ✅
- 内存使用：假设平均运行 2 小时/天 = 60 小时 = 216,000 秒
  - 256Mi × 216,000 秒 = 55,296,000 Mi-秒 = 54,000 GB-秒
  - 54,000 / 360,000 = **15%** ✅
- CPU 使用：0.5 × 216,000 = 108,000 vCPU-秒
  - 108,000 / 180,000 = **60%** ✅
- **结论：完全在免费额度内** ✅

### 场景 2: 中等流量网站（每月 100,000 次请求）
- 请求数：100,000 / 2,000,000 = **5%** ✅
- 内存使用：假设平均运行 8 小时/天 = 240 小时 = 864,000 秒
  - 256Mi × 864,000 秒 = 221,184,000 Mi-秒 = 216,000 GB-秒
  - 216,000 / 360,000 = **60%** ✅
- CPU 使用：0.5 × 864,000 = 432,000 vCPU-秒
  - 432,000 / 180,000 = **240%** ⚠️ (超出免费额度)
- **结论：可能需要少量付费（约 $0.10-0.50/月）**

### 场景 3: 高流量网站（每月 500,000 次请求）
- 请求数：500,000 / 2,000,000 = **25%** ✅
- 内存和 CPU 使用会超出免费额度
- **结论：需要付费，但成本仍然很低（约 $5-15/月）**

---

## 🚀 部署步骤（免费层优化）

### 步骤 1: 启用必要的 API（免费）

```bash
gcloud services enable \
  run.googleapis.com \
  cloudbuild.googleapis.com \
  artifactregistry.googleapis.com \
  --project=882380127696
```

### 步骤 2: 创建 Artifact Registry 仓库

```bash
gcloud artifacts repositories create apony-website \
  --repository-format=docker \
  --location=asia-east1 \
  --description="AponyGroup website Docker images" \
  --project=882380127696
```

### 步骤 3: 部署（使用优化脚本）

```bash
# 运行部署脚本（已优化为免费层配置）
./deploy.sh
```

---

## 💰 超出免费额度后的成本

如果超出免费额度，费用非常低：

### Cloud Run 超出免费额度后的定价（亚洲区域）
- **内存**: $0.0000025/GB-秒（超出部分）
- **CPU**: $0.00002400/vCPU-秒（超出部分）
- **请求**: $0.40/百万次请求（超出部分）

### 示例计算（中等流量网站）
假设超出：
- 252,000 vCPU-秒（432,000 - 180,000）
- 成本 = 252,000 × $0.00002400 = **$6.05/月**

---

## 📈 监控免费额度使用

### 在 GCP 控制台查看
1. 访问 [Cloud Run 配额](https://console.cloud.google.com/run?project=882380127696)
2. 查看服务指标和资源使用

### 使用命令行查看
```bash
# 查看服务指标
gcloud run services describe apony-website \
  --region asia-east1 \
  --format="table(status.conditions,status.url)" \
  --project=882380127696
```

### 设置预算警报
1. 访问 [预算和警报](https://console.cloud.google.com/billing/budgets?project=882380127696)
2. 创建预算（例如：$5/月）
3. 设置警报阈值（例如：50%, 90%, 100%）

---

## ⚠️ 免费层注意事项

### 1. 需要关联计费账户
- GCP 免费层**仍然需要关联有效的计费账户**
- 但不会在免费额度内收费
- 超出免费额度后才会产生费用

### 2. 冷启动延迟
- 最小实例 = 0 时，首次请求会有 1-3 秒冷启动
- 如果希望消除冷启动，可设置最小实例 = 1（会产生少量费用）

### 3. 资源限制
- 256Mi 内存对复杂应用可能不够
- 如果应用需要更多资源，可以调整配置（会产生费用）

### 4. 区域选择
- 选择 `asia-east1`（台湾）因为：
  - 距离近，延迟低
  - 价格相对较低
  - 免费额度全球通用

---

## 🔧 优化建议

### 如果接近免费额度限制

1. **优化应用性能**
   - 减少内存使用
   - 优化代码执行时间
   - 使用 CDN 缓存静态资源

2. **调整配置**
   - 如果流量稳定，可设置最小实例 = 1（消除冷启动，但会产生费用）
   - 如果流量波动大，保持最小实例 = 0

3. **使用 Cloud CDN**
   - 缓存静态资源
   - 减少 Cloud Run 请求数
   - 有免费额度：每月 1GB 出站流量

---

## 📝 总结

✅ **当前配置完全适合免费层使用**
- 低到中等流量网站可以完全免费运行
- 配置已优化为最小资源使用
- 使用 Artifact Registry 避免存储费用

✅ **超出免费额度后成本仍然很低**
- 中等流量网站：约 $5-10/月
- 高流量网站：约 $15-30/月

✅ **可以随时调整配置**
- 如果流量增长，可以增加资源
- 如果流量减少，可以降低资源

---

## 🆘 需要帮助？

- 查看详细部署文档：`DEPLOYMENT.md`
- 查看快速开始：`QUICK_START.md`
- [GCP 免费层文档](https://cloud.google.com/free/docs/free-cloud-features)
- [Cloud Run 定价](https://cloud.google.com/run/pricing)

